{% extends "base.html" %}

{% block title %}
{% if activity.is_some() %}Edit Activity{% else %}Log Activity{% endif %} - CRM - Allo
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center space-x-8">
                    <a href="/dashboard" class="text-xl font-semibold text-gray-900">Allo</a>
                    <div class="flex space-x-4">
                        <a href="/crm" class="text-gray-500 hover:text-gray-700">CRM</a>
                        <a href="/crm/activities" class="text-indigo-600 font-medium">Activities</a>
                    </div>
                </div>
                <div class="flex items-center">
                    <a href="/crm/activities" class="text-gray-500 hover:text-gray-700">‚Üê Back to Activities</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-3xl mx-auto py-6 sm:px-6 lg:px-8">
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    {% if activity.is_some() %}Edit Activity{% else %}Log New Activity{% endif %}
                </h3>
            </div>

            <form action="{% if activity.is_some() %}/crm/activities/{{ activity.as_ref().unwrap().id }}{% else %}/crm/activities{% endif %}" 
                    method="POST" class="p-6 space-y-6">

                <!-- Activity Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label for="subject" class="block text-sm font-medium text-gray-700">
                            Subject *
                        </label>
                        <input type="text" id="subject" name="subject" required
                               value="{% if activity.is_some() %}{{ activity.as_ref().unwrap().subject }}{% endif %}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="activity_type" class="block text-sm font-medium text-gray-700">
                            Activity Type *
                        </label>
                        <select id="activity_type" name="activity_type" required
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="call" {% if !activity.is_some() || activity.as_ref().unwrap().activity_type == "call" %}selected{% endif %}>Call</option>
                            <option value="meeting" {% if activity.is_some() && activity.as_ref().unwrap().activity_type == "meeting" %}selected{% endif %}>Meeting</option>
                            <option value="email" {% if activity.is_some() && activity.as_ref().unwrap().activity_type == "email" %}selected{% endif %}>Email</option>
                            <option value="note" {% if activity.is_some() && activity.as_ref().unwrap().activity_type == "note" %}selected{% endif %}>Note</option>
                            <option value="task" {% if activity.is_some() && activity.as_ref().unwrap().activity_type == "task" %}selected{% endif %}>Task</option>
                        </select>
                    </div>

                    <div>
                        <label for="customer_id" class="block text-sm font-medium text-gray-700">
                            Customer *
                        </label>
                        <select id="customer_id" name="customer_id" required onchange="updateContactsAndDeals()"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select Customer</option>
                            {% for customer in customers %}
                            <option value="{{ customer.id }}" 
                                {% if customer_id.is_some() && customer_id.unwrap() == customer.id %}selected{% endif %}
                                {% if activity.is_some() && activity.as_ref().unwrap().customer_id == customer.id %}selected{% endif %}>
                                {{ customer.company_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="contact_id" class="block text-sm font-medium text-gray-700">
                            Contact
                        </label>
                        <select id="contact_id" name="contact_id"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select Contact</option>
                            {% for contact in contacts %}
                            <option value="{{ contact.id }}"
                                {% if activity.is_some() && activity.as_ref().unwrap().contact_id.is_some() && activity.as_ref().unwrap().contact_id.unwrap() == contact.id %}selected{% endif %}>
                                {{ contact.first_name }} {{ contact.last_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="deal_id" class="block text-sm font-medium text-gray-700">
                            Related Deal
                        </label>
                        <select id="deal_id" name="deal_id"
                                class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="">Select Deal</option>
                            {% for deal in deals %}
                            <option value="{{ deal.id }}"
                                {% if deal_id.is_some() && deal_id.unwrap() == deal.id %}selected{% endif %}
                                {% if activity.is_some() && activity.as_ref().unwrap().deal_id.is_some() && activity.as_ref().unwrap().deal_id.unwrap() == deal.id %}selected{% endif %}>
                                {{ deal.title }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div>
                        <label for="activity_date" class="block text-sm font-medium text-gray-700">
                            Activity Date *
                        </label>
                        <input type="datetime-local" id="activity_date" name="activity_date" required
                               value="{% if activity.is_some() %}{{ activity.as_ref().unwrap().activity_date.format("%Y-%m-%dT%H:%M") }}{% endif %}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div>
                        <label for="duration_minutes" class="block text-sm font-medium text-gray-700">
                            Duration (minutes)
                        </label>
                        <input type="number" id="duration_minutes" name="duration_minutes" min="0"
                               value="{% if activity.is_some() && activity.as_ref().unwrap().duration_minutes.is_some() %}{{ activity.as_ref().unwrap().duration_minutes.unwrap() }}{% endif %}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    </div>

                    <div class="md:col-span-2">
                        <label for="description" class="block text-sm font-medium text-gray-700">
                            Description
                        </label>
                        <textarea id="description" name="description" rows="4"
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">{% if activity.is_some() && activity.as_ref().unwrap().description.is_some() %}{{ activity.as_ref().unwrap().description.as_ref().unwrap() }}{% endif %}</textarea>
                    </div>

                    <div class="md:col-span-2">
                        <label class="flex items-center">
                            <input type="checkbox" name="completed" value="true" 
                                   {% if activity.is_some() && activity.as_ref().unwrap().completed %}checked{% endif %}
                                   class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <span class="text-sm font-medium text-gray-700">Mark as completed</span>
                        </label>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-3 pt-6 border-t">
                    <a href="/crm/activities" 
                       class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400">
                        Cancel
                    </a>
                    <button type="submit" 
                            class="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">
                        {% if activity.is_some() %}Update Activity{% else %}Log Activity{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Set default datetime to now if creating new activity
document.addEventListener('DOMContentLoaded', function() {
    const activityDateInput = document.getElementById('activity_date');
    if (!activityDateInput.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        activityDateInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
});

function updateContactsAndDeals() {
    const customerSelect = document.getElementById('customer_id');
    const contactSelect = document.getElementById('contact_id');
    const dealSelect = document.getElementById('deal_id');
    const customerId = customerSelect.value;
    
    // Clear existing options
    contactSelect.innerHTML = '<option value="">Select Contact</option>';
    dealSelect.innerHTML = '<option value="">Select Deal</option>';
    
    if (customerId) {
        // This would need API endpoints to work properly
        // For now, we'll refresh the page with the customer_id parameter
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('customer_id', customerId);
        window.location.href = currentUrl.toString();
    }
}
</script>
{% endblock %}